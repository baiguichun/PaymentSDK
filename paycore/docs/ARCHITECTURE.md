# èšåˆæ”¯ä»˜SDKæ¶æ„è®¾è®¡æ–‡æ¡£

## 1. æ¶æ„æ¦‚è§ˆ

èšåˆæ”¯ä»˜SDKé‡‡ç”¨æ¨¡å—åŒ–ã€æ’ä»¶åŒ–çš„æ¶æ„è®¾è®¡ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯å°†æ”¯ä»˜æ¸ é“ä½œä¸ºç‹¬ç«‹çš„SDKæ¨¡å—ï¼Œå®ç°æŒ‰éœ€é›†æˆã€‚

### 1.1 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         åº”ç”¨å±‚ (APP)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           Application (åˆå§‹åŒ–ã€æ³¨å†Œæ¸ é“)                â”‚  â”‚
â”‚  â”‚           Activity (å‘èµ·æ”¯ä»˜ã€å¤„ç†ç»“æœ)                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ ¸å¿ƒSDKå±‚ (payment-core)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ PaymentSDK â”‚  â”‚ChannelManager â”‚  â”‚PaymentSheetDialogâ”‚   â”‚
â”‚  â”‚  (å…¥å£ç±»)   â”‚  â”‚  (æ¸ é“ç®¡ç†)     â”‚  â”‚   (UIç»„ä»¶)       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          IPaymentChannel (æ”¯ä»˜æ¸ é“æ¥å£)                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚PaymentLifecycleAct â”‚  â”‚    PaymentApiService      â”‚    â”‚
â”‚  â”‚  (ç”Ÿå‘½å‘¨æœŸç›‘å¬)      â”‚  â”‚    (ç½‘ç»œè¯·æ±‚)              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚PaymentLockMgr â”‚  â”‚AppInstall   â”‚  â”‚SecuritySignerâ”‚    â”‚
â”‚  â”‚  (å¹¶å‘æ§åˆ¶)     â”‚  â”‚  Checker    â”‚  â”‚  (å®‰å…¨ç­¾å)   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ”¯ä»˜æ¸ é“SDKå±‚ (ç‹¬ç«‹æ¨¡å—)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ WeChatPay    â”‚  â”‚   Alipay     â”‚  â”‚  UnionPay    â”‚      â”‚
â”‚  â”‚   Channel    â”‚  â”‚   Channel    â”‚  â”‚   Channel    â”‚ ...  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç¬¬ä¸‰æ–¹æ”¯ä»˜SDKå±‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  å¾®ä¿¡å¼€æ”¾SDK   â”‚  â”‚  æ”¯ä»˜å®SDK     â”‚  â”‚   é“¶è”SDK     â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         åç«¯æœåŠ¡                              â”‚
â”‚  - æ”¯ä»˜æ¸ é“é…ç½®æ¥å£ (æ ¹æ®ä¸šåŠ¡çº¿ä¸‹å‘å¯ç”¨æ¸ é“)                    â”‚
â”‚  - æ”¯ä»˜è®¢å•åˆ›å»ºæ¥å£ (è·å–é¢„æ”¯ä»˜å‚æ•°)                           â”‚
â”‚  - æ”¯ä»˜ç»“æœé€šçŸ¥æ¥å£ (æ¥æ”¶ç¬¬ä¸‰æ–¹æ”¯ä»˜å›è°ƒ)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2. æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 2.1 PaymentSDK (å…¥å£ç±»)

**èŒè´£ï¼š**
- SDKåˆå§‹åŒ–å’Œé…ç½®ç®¡ç†
- æ”¯ä»˜æ¸ é“æ³¨å†Œ
- ç»Ÿä¸€çš„æ”¯ä»˜å…¥å£
- å…¨å±€ç”Ÿå‘½å‘¨æœŸç®¡ç†

**å…³é”®æ–¹æ³•ï¼š**
```kotlin
// åˆå§‹åŒ–SDK
fun init(app: Application, config: PaymentConfig)

// æ³¨å†Œæ”¯ä»˜æ¸ é“
fun registerChannel(channel: IPaymentChannel)
fun registerChannels(channels: List<IPaymentChannel>)

// æ˜¾ç¤ºæ”¯ä»˜æ¸ é“é€‰æ‹©å¼¹çª—ï¼ˆè‡ªåŠ¨å®Œæˆæ”¯ä»˜ï¼‰
fun showPaymentSheet(
    activity: Activity,  // âœ… æ”¯æŒä»»ä½•Activity
    orderId: String,
    amount: BigDecimal,
    extraParams: Map<String, Any> = emptyMap(),
    businessLine: String? = null,
    onPaymentResult: (PaymentResult) -> Unit,  // âœ… è¿”å›æ”¯ä»˜ç»“æœ
    onCancelled: () -> Unit
)

// ä½¿ç”¨æŒ‡å®šæ¸ é“æ”¯ä»˜ï¼ˆæ¨èï¼‰
fun payWithChannel(
    channelId: String,
    context: Context,
    orderId: String,
    amount: BigDecimal,
    extraParams: Map<String, Any> = emptyMap(),
    onResult: (PaymentResult) -> Unit
)

// suspendç‰ˆæœ¬ï¼ˆå·²åºŸå¼ƒï¼‰
@Deprecated("æ¨èä½¿ç”¨å›è°ƒç‰ˆæœ¬")
suspend fun payWithChannel(...): PaymentResult

// æ‰‹åŠ¨æŸ¥è¯¢è®¢å•çŠ¶æ€
suspend fun queryOrderStatus(orderId: String): PaymentResult
```

### 2.2 IPaymentChannel (æ”¯ä»˜æ¸ é“æ¥å£)

**èŒè´£ï¼š**
- å®šä¹‰æ”¯ä»˜æ¸ é“çš„ç»Ÿä¸€æ¥å£
- å°è£…å„æ”¯ä»˜æ¸ é“çš„å·®å¼‚

**å…³é”®å±æ€§å’Œæ–¹æ³•ï¼š**
```kotlin
interface IPaymentChannel {
    val channelId: String          // æ¸ é“å”¯ä¸€æ ‡è¯†
    val channelName: String        // æ¸ é“æ˜¾ç¤ºåç§°
    val channelIcon: Int           // æ¸ é“å›¾æ ‡
    val requiresApp: Boolean       // æ˜¯å¦éœ€è¦ç¬¬ä¸‰æ–¹APP
    val packageName: String?       // APPåŒ…å
    val priority: Int              // ä¼˜å…ˆçº§
    
    // æ‰§è¡Œæ”¯ä»˜ï¼ˆåŒæ­¥æ–¹æ³•ï¼‰
    fun pay(
        context: Context,
        orderId: String,
        amount: BigDecimal,
        extraParams: Map<String, Any>
    ): PaymentResult
    
    // æ£€æŸ¥APPæ˜¯å¦å®‰è£…
    fun isAppInstalled(context: Context): Boolean
}
```

### 2.3 PaymentChannelManager (æ¸ é“ç®¡ç†å™¨)

**èŒè´£ï¼š**
- ç®¡ç†æ‰€æœ‰æ³¨å†Œçš„æ”¯ä»˜æ¸ é“
- æ¸ é“æŸ¥è¯¢å’Œè¿‡æ»¤
- éªŒè¯æ¸ é“å¯ç”¨æ€§

**å…³é”®æ–¹æ³•ï¼š**
```kotlin
// æ³¨å†Œæ¸ é“
fun registerChannel(channel: IPaymentChannel)

// è·å–æ‰€æœ‰å·²æ³¨å†Œæ¸ é“
fun getAllChannels(): List<IPaymentChannel>

// è·å–å¯ç”¨æ¸ é“ï¼ˆå·²æ³¨å†Œä¸”APPå·²å®‰è£…ï¼‰
fun getAvailableChannels(context: Context): List<IPaymentChannel>

// æ ¹æ®åç«¯é…ç½®è¿‡æ»¤å¯ç”¨æ¸ é“
fun filterAvailableChannels(
    context: Context,
    channelIds: List<String>
): List<IPaymentChannel>
```

### 2.4 PaymentSheetDialog (æ”¯ä»˜é€‰æ‹©å¯¹è¯æ¡†)

> ğŸ’¡ ä½¿ç”¨ `BottomSheetDialog` å®ç°ï¼Œæ”¯æŒä»»ä½•ç±»å‹çš„Activity

**èŒè´£ï¼š**
- å±•ç¤ºæ”¯ä»˜æ¸ é“é€‰æ‹©UI
- ä»åç«¯è·å–æ¸ é“é…ç½®
- è¿‡æ»¤å¹¶æ˜¾ç¤ºå¯ç”¨æ¸ é“
- è‡ªåŠ¨è°ƒèµ·æ”¯ä»˜å¹¶è¿”å›ç»“æœ

**å·¥ä½œæµç¨‹ï¼š**
```
1. æ˜¾ç¤ºåŠ è½½çŠ¶æ€
2. è¯·æ±‚åç«¯è·å–ä¸šåŠ¡çº¿å¯ç”¨æ¸ é“é…ç½®
3. è¿‡æ»¤å‡ºæœ¬åœ°å·²æ³¨å†Œçš„æ¸ é“
4. è¿‡æ»¤å‡ºAPPå·²å®‰è£…çš„æ¸ é“
5. æŒ‰ä¼˜å…ˆçº§æ’åºåå±•ç¤º
6. ç”¨æˆ·é€‰æ‹©æ¸ é“
7. è‡ªåŠ¨è°ƒèµ·æ”¯ä»˜ï¼ˆè°ƒç”¨ payWithChannelï¼‰
8. è¿”å›æ”¯ä»˜ç»“æœ
```

**ç‰¹æ€§ï¼š**
- âœ… æ”¯æŒä»»ä½•Activityç±»å‹
- âœ… è‡ªåŠ¨ç®¡ç†åç¨‹ä½œç”¨åŸŸ
- âœ… Dialogå…³é—­æ—¶è‡ªåŠ¨å–æ¶ˆç½‘ç»œè¯·æ±‚
- âœ… å†…éƒ¨é›†æˆæ”¯ä»˜æµç¨‹

### 2.5 PaymentLifecycleActivity (ç”Ÿå‘½å‘¨æœŸç›‘å¬)

> ğŸ’¡ é€æ˜Activityè‡ªåŠ¨ç›‘å¬æ”¯ä»˜ç”Ÿå‘½å‘¨æœŸ

**èŒè´£ï¼š**
- ç›‘å¬ç”¨æˆ·ä»ç¬¬ä¸‰æ–¹APPè¿”å›
- è‡ªåŠ¨æŸ¥è¯¢æ”¯ä»˜ç»“æœ
- å¤„ç†æ”¯ä»˜ç»“æœå›è°ƒ
- å®Œå…¨é€æ˜ï¼Œå¯¹ç”¨æˆ·æ— æ„ŸçŸ¥

**å·¥ä½œæµç¨‹ï¼š**
```
1. onCreate: å¯åŠ¨é€æ˜Activityï¼Œå‘èµ·æ”¯ä»˜
2. è°ƒèµ·ç¬¬ä¸‰æ–¹APPï¼ˆå¾®ä¿¡/æ”¯ä»˜å®ï¼‰
3. onPause: ç”¨æˆ·è·³è½¬åˆ°ç¬¬ä¸‰æ–¹APP
4. ã€ç”¨æˆ·å®Œæˆæ”¯ä»˜ã€‘
5. onResume: æ£€æµ‹åˆ°ç”¨æˆ·è¿”å›
6. å»¶è¿ŸNç§’åæŸ¥è¯¢æ”¯ä»˜ç»“æœ
7. è½®è¯¢æŸ¥è¯¢åç«¯ï¼ˆæœ€å¤šMæ¬¡ï¼‰
8. è¿”å›æœ€ç»ˆPaymentResult
9. å…³é—­é€æ˜Activity
```

**å…³é”®ç‰¹æ€§ï¼š**
- ä½¿ç”¨ `ConcurrentHashMap` ç®¡ç†å¤šä¸ªæ”¯ä»˜å›è°ƒ
- æ”¯æŒåŒæ—¶è¿›è¡Œå¤šä¸ªæ”¯ä»˜
- è‡ªåŠ¨é˜²æ­¢å†…å­˜æ³„æ¼
- ä¸»é¢˜è®¾ç½®ä¸ºå®Œå…¨é€æ˜
- Activity å¦‚è¢«ç³»ç»Ÿå›æ”¶ä¸”æœªèƒ½æ­£å¸¸ç»“æŸï¼Œä¼šå…œåº•å›è°ƒ `PaymentResult.Failed("æ”¯ä»˜æµç¨‹å·²ä¸­æ–­ï¼Œè¯·é‡è¯•")` å¹¶æ¸…ç†å›è°ƒï¼Œé¿å…æ‚¬æŒ‚

**ä¸»é¢˜é…ç½®ï¼š**
```xml
<style name="Theme.PaymentCore.Transparent">
    <item name="android:windowIsTranslucent">true</item>
    <item name="android:windowBackground">@android:color/transparent</item>
    <item name="android:windowIsFloating">true</item>
    <item name="android:backgroundDimEnabled">false</item>
</style>
```

### 2.6 AppInstallChecker (APPå®‰è£…æ£€æµ‹)

**èŒè´£ï¼š**
- æ£€æµ‹ç¬¬ä¸‰æ–¹æ”¯ä»˜APPæ˜¯å¦å·²å®‰è£…
- æ”¯æŒæ‰¹é‡æ£€æµ‹

**å…³é”®æ–¹æ³•ï¼š**
```kotlin
// æ£€æŸ¥å•ä¸ªAPP
fun isPackageInstalled(context: Context, packageName: String): Boolean

// æ‰¹é‡æ£€æŸ¥
fun checkMultipleApps(
    context: Context,
    packageNames: List<String>
): Map<String, Boolean>
```

### 2.7 PaymentApiService (ç½‘ç»œæœåŠ¡)

**èŒè´£ï¼š**
- ä¸åç«¯é€šä¿¡
- è·å–æ”¯ä»˜æ¸ é“é…ç½®
- åˆ›å»ºæ”¯ä»˜è®¢å•
- æŸ¥è¯¢è®¢å•çŠ¶æ€
- åŸºäº Retrofit + OkHttp è°ƒç”¨ï¼Œä½¿ç”¨ Scalars è½¬æ¢å™¨è·å–åŸå§‹å­—ç¬¦ä¸²ï¼Œå†ç”¨ JSONObject è§£æï¼Œå…¼å®¹åŠ¨æ€å­—æ®µï¼ˆå¦‚ extraConfigï¼‰
- ä¿è¯è§£æå¼‚å¸¸ç›´æ¥æŠ›å‡ºï¼Œè°ƒç”¨æ–¹å¯æ”¶åˆ° `Result.failure` å¤„ç†

**å…³é”®æ–¹æ³•ï¼š**
```kotlin
// è·å–æ”¯ä»˜æ¸ é“é…ç½®
suspend fun getPaymentChannels(
    businessLine: String,
    appId: String
): Result<List<PaymentChannelMeta>>

// åˆ›å»ºæ”¯ä»˜è®¢å•
suspend fun createPaymentOrder(
    orderId: String,
    channelId: String,
    amount: String,
    extraParams: Map<String, Any>
): Result<Map<String, Any>>

// æŸ¥è¯¢è®¢å•çŠ¶æ€ï¼ˆv2.0æ–°å¢ï¼‰
suspend fun queryOrderStatus(
    orderId: String,
    paymentId: String? = null
): Result<OrderStatusInfo>
```

### 2.8 PaymentLockManager (å¹¶å‘æ§åˆ¶)

> è®¢å•çº§é”ç®¡ç†ï¼Œé˜²æ­¢é‡å¤æ”¯ä»˜å’Œé‡å¤æŸ¥è¯¢

**èŒè´£ï¼š**
- ç®¡ç†è®¢å•çº§åˆ«çš„é”
- é˜²æ­¢åŒä¸€è®¢å•é‡å¤æ”¯ä»˜
- é˜²æ­¢åŒä¸€è®¢å•é‡å¤æŸ¥è¯¢
- è‡ªåŠ¨é‡Šæ”¾é”èµ„æº

**å…³é”®æ–¹æ³•ï¼š**
```kotlin
// å°è¯•é”å®šè®¢å•(æ”¯æŒè¶…æ—¶è‡ªåŠ¨é‡Šæ”¾)
fun tryLockOrder(orderId: String, timeoutMs: Long = 300000): Boolean

// é‡Šæ”¾è®¢å•é”
fun unlockOrder(orderId: String)

// æ£€æŸ¥è®¢å•æ˜¯å¦æ­£åœ¨æ”¯ä»˜ä¸­
fun isOrderPaying(orderId: String): Boolean

// è®¾ç½®è¶…æ—¶å›è°ƒ(å¯é€‰,ç”¨äºæ—¥å¿—è®°å½•)
fun setOnTimeoutCallback(callback: ((orderId: String) -> Unit)?)

// è·å–æ­£åœ¨æ”¯ä»˜çš„è®¢å•åˆ—è¡¨(è°ƒè¯•ç”¨)
fun getPayingOrders(): Set<String>

// æ¸…ç†æ‰€æœ‰é”(æµ‹è¯•ç”¨)
fun clearAll()

// å…³é—­é”ç®¡ç†å™¨(SDKå…³é—­æ—¶è°ƒç”¨)
fun shutdown()
```

**å·¥ä½œåŸç†ï¼š**
```kotlin
// ä½¿ç”¨ ConcurrentHashMap å­˜å‚¨æ­£åœ¨æ”¯ä»˜ä¸­çš„è®¢å•
private val payingOrders = ConcurrentHashMap.newKeySet<String>()
private val timeoutJobs = ConcurrentHashMap<String, Job>()
private val managerLock = ReentrantLock()
private val timeoutScope = CoroutineScope(SupervisorJob() + Dispatchers.Default)

fun tryLockOrder(orderId: String, timeoutMs: Long = 300000): Boolean {
    managerLock.withLock {
        // æ£€æŸ¥è®¢å•æ˜¯å¦å·²åœ¨æ”¯ä»˜ä¸­
        if (payingOrders.contains(orderId)) {
            return false
        }
        // æ ‡è®°è®¢å•ä¸ºæ”¯ä»˜ä¸­
        payingOrders.add(orderId)
        
        // å¯åŠ¨è¶…æ—¶ä»»åŠ¡ï¼ˆè‡ªåŠ¨é‡Šæ”¾é”ï¼‰
        startTimeoutTask(orderId, timeoutMs)
        
        return true
    }
}

fun unlockOrder(orderId: String) {
    managerLock.withLock {
        payingOrders.remove(orderId)
        // å–æ¶ˆè¶…æ—¶ä»»åŠ¡
        timeoutJobs.remove(orderId)?.cancel()
    }
}

// è¶…æ—¶ä»»åŠ¡ï¼šè‡ªåŠ¨é‡Šæ”¾é”ï¼ˆé˜²æ­¢æ­»é”ï¼‰
private fun startTimeoutTask(orderId: String, timeoutMs: Long) {
    // å–æ¶ˆä¹‹å‰çš„è¶…æ—¶ä»»åŠ¡(å¦‚æœå­˜åœ¨)
    timeoutJobs.remove(orderId)?.cancel()
    
    val timeoutJob = timeoutScope.launch {
        try {
            delay(timeoutMs)  // ç­‰å¾…è¶…æ—¶
            managerLock.withLock {
                if (payingOrders.contains(orderId)) {
                    payingOrders.remove(orderId)  // è‡ªåŠ¨é‡Šæ”¾
                    timeoutJobs.remove(orderId)
                    onTimeoutCallback?.invoke(orderId)  // è§¦å‘å›è°ƒ
                }
            }
        } catch (e: Exception) {
            // ä»»åŠ¡è¢«å–æ¶ˆï¼Œå¿½ç•¥
        }
    }
    timeoutJobs[orderId] = timeoutJob
}
```

**è¶…æ—¶è‡ªåŠ¨é‡Šæ”¾æœºåˆ¶ï¼š**
- âœ… é˜²æ­¢ APP å´©æºƒæˆ–è¿›ç¨‹è¢«æ€æ­»å¯¼è‡´çš„é”æ°¸ä¹…æŒæœ‰
- âœ… è®¢å•é”åœ¨é…ç½®çš„æ—¶é—´åè‡ªåŠ¨é‡Šæ”¾ï¼ˆé»˜è®¤5åˆ†é’Ÿ,å¯é€šè¿‡`orderLockTimeoutMs`é…ç½®ï¼‰
- âœ… æå‡ç”¨æˆ·ä½“éªŒï¼Œç”¨æˆ·å¯ä»¥åœ¨è¶…æ—¶åé‡æ–°æ”¯ä»˜
- âœ… å¯é€šè¿‡å›è°ƒç›‘å¬é”è¶…æ—¶äº‹ä»¶,ä¾¿äºæ—¥å¿—è®°å½•å’Œç›‘æ§

**æŸ¥è¯¢å»é‡æœºåˆ¶ï¼ˆv2.0.1æ–°å¢ï¼‰ï¼š**

ä¸ºäº†é¿å…åŒä¸€è®¢å•çš„å¹¶å‘é‡å¤æŸ¥è¯¢ï¼ŒSDKåœ¨`PaymentSDK`ä¸­ä½¿ç”¨ `CompletableDeferred` å®ç°æŸ¥è¯¢å»é‡ï¼š

```kotlin
// PaymentSDKä¸­çš„æŸ¥è¯¢å»é‡
private val activeQueries = ConcurrentHashMap<String, CompletableDeferred<PaymentResult>>()

private suspend fun queryPaymentResultWithRetry(orderId: String): PaymentResult {
    // 1. æ£€æŸ¥æ˜¯å¦å·²æœ‰æ­£åœ¨è¿›è¡Œçš„æŸ¥è¯¢
    val existingQuery = activeQueries[orderId]
    if (existingQuery != null) {
        if (config.debugMode) {
            println("è®¢å• $orderId æ­£åœ¨æŸ¥è¯¢ä¸­ï¼Œç­‰å¾…ç°æœ‰æŸ¥è¯¢å®Œæˆ...")
        }
        // ç­‰å¾…ç°æœ‰æŸ¥è¯¢å®Œæˆï¼Œé¿å…é‡å¤è¯·æ±‚
        return try {
            existingQuery.await()
        } catch (e: Exception) {
            PaymentResult.Failed("æŸ¥è¯¢å¤±è´¥: ${e.message}")
        }
    }
    
    // 2. åˆ›å»ºæ–°çš„æŸ¥è¯¢ä»»åŠ¡
    val queryDeferred = CompletableDeferred<PaymentResult>()
    activeQueries[orderId] = queryDeferred
    
    try {
        // 3. æ‰§è¡Œå®é™…æŸ¥è¯¢(æ”¯æŒé‡è¯•å’Œè¶…æ—¶)
        val result = performActualQueryWithRetry(orderId)
        
        // 4. é€šçŸ¥æ‰€æœ‰ç­‰å¾…çš„åç¨‹
        queryDeferred.complete(result)
        
        return result
    } catch (e: Exception) {
        val errorResult = PaymentResult.Failed("æŸ¥è¯¢å¼‚å¸¸: ${e.message}")
        queryDeferred.completeExceptionally(e)
        return errorResult
    } finally {
        // 5. æ¸…ç†æŸ¥è¯¢è®°å½•
        activeQueries.remove(orderId)
    }
}
```

**è§£å†³çš„é—®é¢˜ï¼š**
- âœ… è‡ªåŠ¨æŸ¥è¯¢ï¼ˆPaymentLifecycleActivityï¼‰+ æ‰‹åŠ¨æŸ¥è¯¢ï¼ˆqueryOrderStatusï¼‰åŒæ—¶å‘ç”Ÿ
- âœ… å¤šä¸ªåç¨‹æŸ¥è¯¢åŒä¸€è®¢å•æ—¶ï¼Œåªæ‰§è¡Œä¸€æ¬¡å®é™…æŸ¥è¯¢
- âœ… å…¶ä»–åç¨‹ç­‰å¾…é¦–æ¬¡æŸ¥è¯¢ç»“æœï¼Œå…±äº«ç›¸åŒç»“æœ
- âœ… è‡ªåŠ¨æ¸…ç†ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
- âœ… å¼‚å¸¸å¤„ç†å®Œå–„,æŸ¥è¯¢å¤±è´¥ä¸å½±å“å…¶ä»–åç¨‹

### 2.9 SecuritySigner (å®‰å…¨ç­¾å)

> æä¾›è¯·æ±‚ç­¾å/éªŒç­¾åŠŸèƒ½,æ”¯æŒHMAC-SHA256ç®—æ³•

**èŒè´£ï¼š**
- ç”Ÿæˆè¯·æ±‚ç­¾å(HMAC-SHA256)
- éªŒè¯å“åº”ç­¾å
- é˜²æ­¢è¯·æ±‚ç¯¡æ”¹å’Œé‡æ”¾æ”»å‡»
- æ”¯æŒæ—¶é—´æˆ³å’Œéšæœºæ•°

**ç­¾åè§„èŒƒï¼š**
```kotlin
// è¯·æ±‚canonical string
val canonicalString = listOf(
    path,                    // APIè·¯å¾„
    canonicalQuery,          // æ’åºåçš„queryå‚æ•°: k1=v1&k2=v2
    body.orEmpty(),         // è¯·æ±‚ä½“(POSTæ—¶)æˆ–ç©ºå­—ç¬¦ä¸²
    timestamp,              // æ—¶é—´æˆ³(æ¯«ç§’)
    nonce                   // 16å­—èŠ‚éšæœºæ•°(Base64)
).joinToString("\n")

// ç­¾å
val signature = Base64(HMAC-SHA256(canonicalString, signingSecret))

// è¯·æ±‚å¤´
headers["X-Signature"] = signature
headers["X-Timestamp"] = timestamp
headers["X-Nonce"] = nonce
```

**å“åº”éªŒç­¾è§„èŒƒ(å¯é€‰):**
```kotlin
// å“åº”canonical string(ä¸å«nonce)
val canonicalString = listOf(
    path,
    canonicalQuery,
    body.orEmpty(),
    serverTimestamp
).joinToString("\n")

// éªŒè¯ç­¾å
val expectedSignature = Base64(HMAC-SHA256(canonicalString, signingSecret))
if (expectedSignature != responseSignature) {
    throw IllegalStateException("Server signature mismatch")
}

// æ£€æŸ¥æ—¶é—´åå·®(é˜²é‡æ”¾)
val skew = abs(System.currentTimeMillis() - serverTimestamp)
if (skew > maxServerClockSkewMs) {
    throw IllegalStateException("Server timestamp skew too large")
}
```

**å…³é”®æ–¹æ³•ï¼š**
```kotlin
// æ„é€ è¯·æ±‚ç­¾åå¤´
fun buildRequestHeaders(
    path: String,
    query: Map<String, String?> = emptyMap(),
    body: String? = null
): Map<String, String>

// éªŒè¯å“åº”ç­¾å
fun verifyResponseSignature(
    responseSignature: String?,
    responseTimestamp: String?,
    path: String,
    query: Map<String, String?> = emptyMap(),
    body: String? = null
): Result<Unit>
```

**é…ç½®å‚æ•°ï¼ˆSecurityConfigï¼‰ï¼š**
```kotlin
data class SecurityConfig(
    // è¯·æ±‚ç­¾å
    val enableSignature: Boolean = false,           // å¯ç”¨è¯·æ±‚ç­¾å
    val signingSecret: String? = null,              // ç­¾åå¯†é’¥(å¼€å¯æ—¶å¿…å¡«)
    val signatureHeader: String = "X-Signature",    // ç­¾åå¤´
    val timestampHeader: String = "X-Timestamp",    // æ—¶é—´æˆ³å¤´
    val nonceHeader: String = "X-Nonce",            // éšæœºæ•°å¤´
    
    // å“åº”éªŒç­¾
    val enableResponseVerification: Boolean = false,         // å¯ç”¨å“åº”éªŒç­¾
    val serverSignatureHeader: String = "X-Server-Signature", // æœåŠ¡ç«¯ç­¾åå¤´
    val serverTimestampHeader: String = "X-Server-Timestamp", // æœåŠ¡ç«¯æ—¶é—´æˆ³å¤´
    val maxServerClockSkewMs: Long = 5 * 60 * 1000,          // å…è®¸æ—¶é—´åå·®(é»˜è®¤5åˆ†é’Ÿ)
    
    // è¯ä¹¦ç»‘å®š
    val enableCertificatePinning: Boolean = false,   // å¯ç”¨è¯ä¹¦ç»‘å®š
    val certificatePins: Map<String, List<String>> = emptyMap() // host -> pins
)
```

**é›†æˆç¤ºä¾‹:**
```kotlin
// 1. é…ç½®å®‰å…¨å‚æ•°
val config = PaymentConfig.Builder()
    .setSecurityConfig(
        SecurityConfig(
            enableSignature = true,
            enableResponseVerification = true,
            signingSecret = "your_shared_secret_with_backend",
            enableCertificatePinning = true,
            certificatePins = mapOf(
                "api.example.com" to listOf(
                    "sha256/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA="
                )
            )
        )
    )
    .build()

// 2. SDKè‡ªåŠ¨å¤„ç†ç­¾åå’ŒéªŒç­¾
PaymentSDK.init(app, config)

// 3. æ‰€æœ‰APIè¯·æ±‚è‡ªåŠ¨æ·»åŠ ç­¾åå¤´
// 4. æ‰€æœ‰APIå“åº”è‡ªåŠ¨éªŒç­¾
```

**å®‰å…¨ä¿éšœï¼š**
- âœ… **é˜²ç¯¡æ”¹**: HMAC-SHA256ä¿è¯è¯·æ±‚/å“åº”å†…å®¹æœªè¢«ç¯¡æ”¹
- âœ… **é˜²é‡æ”¾**: æ—¶é—´æˆ³+éšæœºæ•°æœºåˆ¶(æœåŠ¡ç«¯å¯é…åˆç¼“å­˜çª—å£æ£€æµ‹)
- âœ… **ä¸­é—´äººé˜²æŠ¤**: Certificate Pinningé˜²æ­¢ä¸­é—´äººæ”»å‡»
- âœ… **å¯†é’¥å®‰å…¨**: ç­¾åå¯†é’¥ä»…å­˜åœ¨å†…å­˜,ä¸æŒä¹…åŒ–
- âœ… **çµæ´»é…ç½®**: å¯å•ç‹¬å¯ç”¨ç­¾åã€éªŒç­¾ã€è¯ä¹¦ç»‘å®š

**æ³¨æ„äº‹é¡¹ï¼š**
1. ç­¾åå¯†é’¥åº”ä¸æœåŠ¡ç«¯çº¦å®šä¸€è‡´,å»ºè®®ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–åŠ å¯†å­˜å‚¨
2. è¯ä¹¦æŒ‡çº¹æ ¼å¼: `sha256/Base64EncodedHash`
3. æ—¶é—´åå·®æ ¡éªŒä¾èµ–å®¢æˆ·ç«¯æ—¶é—´å‡†ç¡®æ€§
4. æœåŠ¡ç«¯åº”å®ç°ç›¸åŒçš„ç­¾å/éªŒç­¾é€»è¾‘
5. å¦‚æœæœªå¯ç”¨ç­¾å,`buildRequestHeaders`è¿”å›ç©ºMap,ä¸å½±å“æ­£å¸¸è¯·æ±‚

## 3. æ”¯ä»˜æµç¨‹è®¾è®¡

### 3.1 å®Œæ•´æ”¯ä»˜æµç¨‹ï¼ˆv2.0ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ç”¨æˆ·ç‚¹å‡»æ”¯ä»˜â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚è°ƒç”¨showPaymentSheetâ”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚æ˜¾ç¤ºPaymentSheetDialog â”‚
â”‚     (åŠ è½½ä¸­)          â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚è¯·æ±‚åç«¯è·å–å¯ç”¨æ¸ é“é…ç½®     â”‚
â”‚ GET /api/payment/channelsâ”‚
â”‚ ?businessLine=xxx&appId=xxxâ”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚è¿‡æ»¤æ¸ é“ï¼š                    â”‚
â”‚1. åç«¯è¿”å›çš„channelIds       â”‚
â”‚2. æœ¬åœ°å·²æ³¨å†Œçš„æ¸ é“           â”‚
â”‚3. è‡ªåŠ¨æ£€æµ‹APPå·²å®‰è£…çš„æ¸ é“     â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚å±•ç¤ºå¯ç”¨æ”¯ä»˜æ¸ é“åˆ—è¡¨           â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ç”¨æˆ·é€‰æ‹©æ”¯ä»˜æ¸ é“              â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚SDKè‡ªåŠ¨è°ƒç”¨payWithChannel    â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚å¯åŠ¨PaymentLifecycleActivity     â”‚
â”‚(é€æ˜Activityï¼Œç”¨æˆ·æ— æ„ŸçŸ¥)         â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚æ£€æŸ¥è®¢å•é”(PaymentLockManager)â”‚
â”‚- å·²é”å®š â†’ è¿”å›å¤±è´¥            â”‚
â”‚- æœªé”å®š â†’ åŠ é”å¹¶ç»§ç»­          â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚è°ƒç”¨ IPaymentChannel.pay()  â”‚
â”‚(æ™®é€šå‡½æ•°ï¼Œésuspend)         â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚è°ƒèµ·ç¬¬ä¸‰æ–¹APP                â”‚
â”‚(å¾®ä¿¡/æ”¯ä»˜å®/é“¶è”)            â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚PaymentLifecycleActivity     â”‚
â”‚onPause - è¿›å…¥åå°            â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ã€ç”¨æˆ·åœ¨ç¬¬ä¸‰æ–¹APPå®Œæˆæ”¯ä»˜ã€‘     â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ç”¨æˆ·ç‚¹å‡»è¿”å›/è‡ªåŠ¨è¿”å›          â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚PaymentLifecycleActivity     â”‚
â”‚onResume - æ£€æµ‹åˆ°ç”¨æˆ·è¿”å›      â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚å»¶è¿ŸæŸ¥è¯¢(initialQueryDelayMs)â”‚
â”‚é»˜è®¤ç­‰å¾…3ç§’                   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚è½®è¯¢æŸ¥è¯¢åç«¯æ”¯ä»˜ç»“æœ           â”‚
â”‚GET /api/payment/status      â”‚
â”‚?orderId=xxx                 â”‚
â”‚                            â”‚
â”‚æœ€å¤šæŸ¥è¯¢Næ¬¡ï¼Œé—´éš”Mç§’           â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚åç«¯è¿”å›è®¢å•çŠ¶æ€ï¼š             â”‚
â”‚- paid â†’ Success            â”‚
â”‚- failed â†’ Failed           â”‚
â”‚- cancelled â†’ Cancelled     â”‚
â”‚- pending/è¶…æ—¶ â†’ Processing  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚é‡Šæ”¾è®¢å•é”                   â”‚
â”‚(PaymentLockManager)         â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚è¿”å›PaymentResult            â”‚
â”‚å…³é—­é€æ˜Activity              â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚å…³é—­PaymentSheetDialog       â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚onPaymentResultå›è°ƒ           â”‚
â”‚ç”¨æˆ·å¤„ç†æœ€ç»ˆç»“æœ               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚å±•ç¤ºå¯ç”¨æ¸ é“åˆ—è¡¨        â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ç”¨æˆ·é€‰æ‹©æ”¯ä»˜æ¸ é“    â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚è°ƒç”¨channel.pay()æ‰§è¡Œæ”¯ä»˜   â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚è°ƒèµ·ç¬¬ä¸‰æ–¹æ”¯ä»˜APP           â”‚
â”‚(å¾®ä¿¡/æ”¯ä»˜å®/é“¶è”ç­‰)         â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ç”¨æˆ·åœ¨ç¬¬ä¸‰æ–¹APPå®Œæˆæ”¯ä»˜      â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚è¿”å›æ”¯ä»˜ç»“æœ               â”‚
â”‚- Success: æ”¯ä»˜æˆåŠŸ         â”‚
â”‚- Failed: æ”¯ä»˜å¤±è´¥          â”‚
â”‚- Cancelled: ç”¨æˆ·å–æ¶ˆ       â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚APPå¤„ç†æ”¯ä»˜ç»“æœ             â”‚
â”‚æŸ¥è¯¢åç«¯ç¡®è®¤æ”¯ä»˜çŠ¶æ€        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ¸ é“è¿‡æ»¤é€»è¾‘

```kotlin
fun filterChannels(
    backendChannelIds: List<String>,    // åç«¯é…ç½®
    registeredChannels: List<IPaymentChannel>, // æœ¬åœ°æ³¨å†Œ
    context: Context                     // ç”¨äºæ£€æµ‹APPå®‰è£…
): List<IPaymentChannel> {
    return backendChannelIds
        .mapNotNull { channelId ->
            // 1. å¿…é¡»æ˜¯æœ¬åœ°å·²æ³¨å†Œçš„æ¸ é“
            registeredChannels.find { it.channelId == channelId }
        }
        .filter { channel ->
            // 2. å¦‚æœéœ€è¦APPï¼Œåˆ™å¿…é¡»å·²å®‰è£…
            !channel.requiresApp || channel.isAppInstalled(context)
        }
        .sortedByDescending { it.priority } // 3. æŒ‰ä¼˜å…ˆçº§æ’åº
}
```

## 4. æ¨¡å—åŒ–è®¾è®¡

### 4.1 æ ¸å¿ƒSDKæ¨¡å— (payment-core)

**å¿…é¡»é›†æˆ**ï¼ŒåŒ…å«ï¼š
- SDKå…¥å£å’Œé…ç½®
- æ”¯ä»˜æ¸ é“æ¥å£å®šä¹‰
- æ¸ é“ç®¡ç†å™¨
- UIç»„ä»¶
- ç½‘ç»œæœåŠ¡
- å·¥å…·ç±»

### 4.2 æ”¯ä»˜æ¸ é“SDKæ¨¡å—

**æŒ‰éœ€é›†æˆ**ï¼Œæ¯ä¸ªæ¸ é“ä¸€ä¸ªç‹¬ç«‹æ¨¡å—ï¼š

- `payment-channel-wechat`: å¾®ä¿¡æ”¯ä»˜
- `payment-channel-alipay`: æ”¯ä»˜å®
- `payment-channel-union`: é“¶è”æ”¯ä»˜
- `payment-channel-custom`: è‡ªå®šä¹‰æ¸ é“

**ä¼˜åŠ¿ï¼š**
1. åº”ç”¨å¯ä»¥åªé›†æˆéœ€è¦çš„æ”¯ä»˜æ¸ é“
2. å‡å°APKä½“ç§¯
3. é¿å…é›†æˆä¸å¿…è¦çš„ç¬¬ä¸‰æ–¹SDK
4. æ˜“äºæ‰©å±•æ–°æ¸ é“

### 4.3 ä¾èµ–å…³ç³»

```gradle
// APPä¾èµ–
dependencies {
    implementation project(':payment-core')          // æ ¸å¿ƒSDKï¼ˆå¿…é¡»ï¼‰
    implementation project(':payment-channel-wechat') // æŒ‰éœ€
    implementation project(':payment-channel-alipay') // æŒ‰éœ€
    implementation project(':payment-channel-union')  // æŒ‰éœ€
}

// æ¸ é“SDKä¾èµ–
dependencies {
    api project(':payment-core')           // ä¾èµ–æ ¸å¿ƒSDK
    implementation 'com.tencent.mm:wechat-sdk' // ç¬¬ä¸‰æ–¹SDK
}
```

## 5. æ‰©å±•æ€§è®¾è®¡

### 5.1 æ–°å¢æ”¯ä»˜æ¸ é“

åªéœ€3æ­¥å³å¯é›†æˆæ–°çš„æ”¯ä»˜æ¸ é“ï¼š

**æ­¥éª¤1ï¼šåˆ›å»ºæ¸ é“SDKæ¨¡å—**
```
payment-channel-custom/
â”œâ”€â”€ build.gradle
â””â”€â”€ src/main/java/com/payment/channel/custom/
    â””â”€â”€ CustomPayChannel.kt
```

**æ­¥éª¤2ï¼šå®ç°IPaymentChannelæ¥å£**
```kotlin
class CustomPayChannel : IPaymentChannel {
    override val channelId = "custom_pay"
    override val channelName = "è‡ªå®šä¹‰æ”¯ä»˜"
    override val channelIcon = R.drawable.ic_custom
    override val requiresApp = true
    override val packageName = "com.custom.pay"
    
    override fun pay(
        context: Context,
        orderId: String,
        amount: BigDecimal,
        extraParams: Map<String, Any>
    ): PaymentResult {
        // è°ƒèµ·ç¬¬ä¸‰æ–¹æ”¯ä»˜APP
        val intent = Intent().apply {
            // è®¾ç½®æ”¯ä»˜å‚æ•°
        }
        context.startActivity(intent)
        
        // ç«‹å³è¿”å›Successï¼Œå®é™…ç»“æœç”±SDKé€šè¿‡åç«¯æŸ¥è¯¢è·å–
        return PaymentResult.Success(orderId)
    }
}
```

**æ­¥éª¤3ï¼šåœ¨Applicationä¸­æ³¨å†Œ**
```kotlin
PaymentSDK.registerChannel(CustomPayChannel())
```

### 5.2 è‡ªå®šä¹‰UI

å¯ä»¥ä¸ä½¿ç”¨é»˜è®¤çš„åŠå±å¼¹çª—ï¼Œè‡ªå·±å®ç°é€‰æ‹©ç•Œé¢ï¼š

```kotlin
// 1. è·å–å¯ç”¨æ¸ é“
val channels = PaymentSDK.getAvailableChannels(context)

// 2. å±•ç¤ºè‡ªå®šä¹‰UI
showCustomChannelPicker(channels) { selectedChannel ->
    // 3. æ‰§è¡Œæ”¯ä»˜
    selectedChannel.pay(...)
}
```

## 6. å®‰å…¨æ€§è®¾è®¡

### 6.1 æ•°æ®å®‰å…¨

1. **æ•æ„Ÿä¿¡æ¯ä¸å­˜å‚¨**ï¼šæ”¯ä»˜å‚æ•°ä»…åœ¨å†…å­˜ä¸­ä¼ é€’ï¼Œä¸æŒä¹…åŒ–
2. **HTTPSé€šä¿¡**ï¼šæ‰€æœ‰ç½‘ç»œè¯·æ±‚ä½¿ç”¨HTTPS
3. **è¯·æ±‚ç­¾å**ï¼šæ”¯æŒHMAC-SHA256ç­¾åé˜²æ­¢ç¯¡æ”¹(å¯é€‰)
4. **å“åº”éªŒç­¾**ï¼šéªŒè¯æœåŠ¡ç«¯å“åº”å®Œæ•´æ€§(å¯é€‰)
5. **é˜²é‡æ”¾æ”»å‡»**ï¼šæ—¶é—´æˆ³+éšæœºæ•°æœºåˆ¶(å¯é€‰)
6. **è¯ä¹¦ç»‘å®š**ï¼šCertificate Pinningé˜²ä¸­é—´äººæ”»å‡»(å¯é€‰)

### 6.2 ç­¾å/éªŒç­¾æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®¢æˆ·ç«¯     â”‚                             â”‚   æœåŠ¡ç«¯     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                             â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                            â”‚
       â”‚ 1. æ„é€ è¯·æ±‚                                â”‚
       â”‚   - path, query, body                     â”‚
       â”‚   - timestamp, nonce                      â”‚
       â”‚                                            â”‚
       â”‚ 2. ç”Ÿæˆç­¾å                                â”‚
       â”‚   signature = HMAC-SHA256(              â”‚
       â”‚     canonicalString,                      â”‚
       â”‚     signingSecret                         â”‚
       â”‚   )                                        â”‚
       â”‚                                            â”‚
       â”‚ 3. æ·»åŠ è¯·æ±‚å¤´                              â”‚
       â”‚   X-Signature: signature                  â”‚
       â”‚   X-Timestamp: timestamp                  â”‚
       â”‚   X-Nonce: nonce                          â”‚
       â”‚                                            â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€ HTTP Request â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                                            â”‚
       â”‚                                 4. éªŒè¯ç­¾åâ”‚
       â”‚                                   (æœåŠ¡ç«¯) â”‚
       â”‚                                            â”‚
       â”‚                                 5. ç”Ÿæˆå“åº”â”‚
       â”‚                                   ç­¾å     â”‚
       â”‚                                   (å¯é€‰)   â”‚
       â”‚                                            â”‚
       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€ HTTP Response â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚   X-Server-Signature: ...                 â”‚
       â”‚   X-Server-Timestamp: ...                 â”‚
       â”‚                                            â”‚
       â”‚ 6. éªŒè¯å“åº”ç­¾å                            â”‚
       â”‚    - æ£€æŸ¥ç­¾ååŒ¹é…                          â”‚
       â”‚    - æ£€æŸ¥æ—¶é—´åå·®                          â”‚
       â”‚                                            â”‚
       â”‚ 7. è§£æå“åº”æ•°æ®                            â”‚
       â”‚                                            â”‚
```

### 6.3 è¯ä¹¦ç»‘å®š(Certificate Pinning)

```kotlin
// åœ¨PaymentApiServiceåˆå§‹åŒ–æ—¶é…ç½®
if (securityConfig.enableCertificatePinning 
    && securityConfig.certificatePins.isNotEmpty()) {
    val pinnerBuilder = CertificatePinner.Builder()
    securityConfig.certificatePins.forEach { (host, pins) ->
        pins.forEach { pinnerBuilder.add(host, it) }
    }
    clientBuilder.certificatePinner(pinnerBuilder.build())
}
```

**è¯ä¹¦æŒ‡çº¹è·å–æ–¹å¼:**
```bash
# æ–¹å¼1: ä½¿ç”¨openssl
echo | openssl s_client -connect api.example.com:443 2>/dev/null \
  | openssl x509 -pubkey -noout \
  | openssl pkey -pubin -outform der \
  | openssl dgst -sha256 -binary \
  | base64

# æ–¹å¼2: åœ¨Chromeä¸­æŸ¥çœ‹è¯ä¹¦è¯¦æƒ…
# è®¿é—®ç½‘ç«™ â†’ é”å›¾æ ‡ â†’ è¯ä¹¦ â†’ è¯¦ç»†ä¿¡æ¯ â†’ å…¬é’¥ä¿¡æ¯

# é…ç½®æ ¼å¼
sha256/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=
```

### 6.4 å®‰å…¨é…ç½®ç¤ºä¾‹

```kotlin
val config = PaymentConfig.Builder()
    .setAppId("your_app_id")
    .setBusinessLine("production")
    .setApiBaseUrl("https://api.example.com")
    .setSecurityConfig(
        SecurityConfig(
            // è¯·æ±‚ç­¾å
            enableSignature = true,
            signingSecret = BuildConfig.PAYMENT_SECRET, // ä»ç¯å¢ƒå˜é‡è¯»å–
            signatureHeader = "X-Signature",
            timestampHeader = "X-Timestamp",
            nonceHeader = "X-Nonce",
            
            // å“åº”éªŒç­¾
            enableResponseVerification = true,
            serverSignatureHeader = "X-Server-Signature",
            serverTimestampHeader = "X-Server-Timestamp",
            maxServerClockSkewMs = 5 * 60 * 1000, // 5åˆ†é’Ÿ
            
            // è¯ä¹¦ç»‘å®š
            enableCertificatePinning = true,
            certificatePins = mapOf(
                "api.example.com" to listOf(
                    "sha256/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=",
                    "sha256/BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB=" // å¤‡ç”¨è¯ä¹¦
                )
            )
        )
    )
    .build()
```

### 6.5 ä»£ç æ··æ·†

```proguard
# æ ¸å¿ƒç±»ä¸æ··æ·†
-keep class com.xiaobai.paycore.PaymentSDK { *; }
-keep class com.xiaobai.paycore.PaymentResult { *; }
-keep class com.xiaobai.paycore.config.PaymentConfig { *; }
-keep interface com.xiaobai.paycore.channel.IPaymentChannel { *; }

# æ¸ é“å®ç°ç±»ä¸æ··æ·†ï¼ˆä¾¿äºåå°„æŸ¥æ‰¾ï¼‰
-keep class * implements com.xiaobai.paycore.channel.IPaymentChannel { *; }

# ç½‘ç»œç›¸å…³ç±»ä¸æ··æ·†
-keep class com.xiaobai.paycore.network.** { *; }

# å®‰å…¨ç›¸å…³ç±»ä¸æ··æ·†(ç­¾åè®¡ç®—éœ€è¦)
-keep class com.xiaobai.paycore.security.** { *; }
-keep class com.xiaobai.paycore.config.SecurityConfig { *; }
```

### 6.6 å®‰å…¨æœ€ä½³å®è·µ

1. **å¯†é’¥ç®¡ç†**
   - ç­¾åå¯†é’¥ä¸è¦ç¡¬ç¼–ç ,ä½¿ç”¨`BuildConfig`æˆ–åŠ å¯†å­˜å‚¨
   - ç”Ÿäº§å’Œæµ‹è¯•ç¯å¢ƒä½¿ç”¨ä¸åŒå¯†é’¥
   - å®šæœŸè½®æ¢å¯†é’¥

2. **è¯ä¹¦ç»‘å®š**
   - é…ç½®ä¸»è¯ä¹¦å’Œå¤‡ç”¨è¯ä¹¦,ä¾¿äºè¯ä¹¦æ›´æ–°
   - ç›‘æ§è¯ä¹¦è¿‡æœŸæ—¶é—´
   - æå‰è§„åˆ’è¯ä¹¦æ›´æ¢æµç¨‹

3. **æ—¶é—´åŒæ­¥**
   - å®¢æˆ·ç«¯æ—¶é—´ä¸å‡†ç¡®ä¼šå¯¼è‡´éªŒç­¾å¤±è´¥
   - `maxServerClockSkewMs`è®¾ç½®åˆç†å€¼(å»ºè®®5-10åˆ†é’Ÿ)
   - æç¤ºç”¨æˆ·æ£€æŸ¥ç³»ç»Ÿæ—¶é—´

4. **é”™è¯¯å¤„ç†**
   - ç­¾å/éªŒç­¾å¤±è´¥æ—¶è®°å½•æ—¥å¿—
   - ä¸è¦åœ¨é”™è¯¯ä¿¡æ¯ä¸­æš´éœ²æ•æ„Ÿä¿¡æ¯
   - æä¾›å‹å¥½çš„é”™è¯¯æç¤º

5. **è°ƒè¯•æ¨¡å¼**
   - ç”Ÿäº§ç¯å¢ƒç¦ç”¨`debugMode`
   - è°ƒè¯•æ¨¡å¼ä¸‹å¯è¾“å‡ºç­¾åè°ƒè¯•ä¿¡æ¯
   - ä½¿ç”¨æ¡ä»¶ç¼–è¯‘éš”ç¦»è°ƒè¯•ä»£ç 

## 7. æ€§èƒ½ä¼˜åŒ–

### 7.1 å¼‚æ­¥å¤„ç†

- æ‰€æœ‰ç½‘ç»œè¯·æ±‚ä½¿ç”¨Kotlin Coroutineså¼‚æ­¥æ‰§è¡Œ
- UIæ“ä½œåœ¨ä¸»çº¿ç¨‹ï¼Œæ”¯ä»˜é€»è¾‘åœ¨IOçº¿ç¨‹

### 7.2 æ‡’åŠ è½½

- æ”¯ä»˜æ¸ é“SDKæŒ‰éœ€åŠ è½½
- UIç»„ä»¶æŒ‰éœ€åˆ›å»º

### 7.3 å†…å­˜ä¼˜åŒ–

- ä½¿ç”¨å•ä¾‹æ¨¡å¼ç®¡ç†æ ¸å¿ƒç»„ä»¶
- åŠæ—¶é‡Šæ”¾ä¸éœ€è¦çš„èµ„æº

## 8. æµ‹è¯•ç­–ç•¥

### 8.1 å•å…ƒæµ‹è¯•

- æ¸ é“ç®¡ç†å™¨æµ‹è¯•
- APPå®‰è£…æ£€æµ‹æµ‹è¯•
- ç½‘ç»œæœåŠ¡æ¨¡æ‹Ÿæµ‹è¯•

### 8.2 é›†æˆæµ‹è¯•

- å®Œæ•´æ”¯ä»˜æµç¨‹æµ‹è¯•
- å¤šæ¸ é“åˆ‡æ¢æµ‹è¯•
- å¼‚å¸¸åœºæ™¯æµ‹è¯•

### 8.3 UIæµ‹è¯•

- åŠå±å¼¹çª—æ˜¾ç¤ºæµ‹è¯•
- æ¸ é“åˆ—è¡¨æ¸²æŸ“æµ‹è¯•
- ç”¨æˆ·äº¤äº’æµ‹è¯•

## 9. åç«¯æ¥å£è®¾è®¡

### 9.1 è·å–æ”¯ä»˜æ¸ é“é…ç½®

```
GET /api/payment/channels

è¯·æ±‚å‚æ•°:
- businessLine: ä¸šåŠ¡çº¿æ ‡è¯†
- appId: åº”ç”¨ID

å“åº”:
{
  "code": 0,
  "data": [
    {
      "channelId": "wechat_pay",
      "channelName": "å¾®ä¿¡æ”¯ä»˜",
      "enabled": true,
      "iconUrl": "https://...",
      "extraConfig": {}
    }
  ]
}
```

### 9.2 åˆ›å»ºæ”¯ä»˜è®¢å•

```
POST /api/payment/create

è¯·æ±‚å‚æ•°:
{
  "orderId": "è®¢å•ID",
  "channelId": "æ”¯ä»˜æ¸ é“ID",
  "amount": "é‡‘é¢",
  "extraParams": {}
}

å“åº”:
{
  "code": 0,
  "data": {
    // å¾®ä¿¡æ”¯ä»˜å‚æ•°
    "prepay_id": "...",
    "sign": "...",
    // æˆ–æ”¯ä»˜å®å‚æ•°
    "order_info": "...",
    // æˆ–é“¶è”å‚æ•°
    "tn": "..."
  }
}
```

## 10. æ€»ç»“

èšåˆæ”¯ä»˜SDKé€šè¿‡æ¨¡å—åŒ–ã€æ’ä»¶åŒ–çš„æ¶æ„è®¾è®¡ï¼Œå®ç°äº†ï¼š

âœ… **çµæ´»é›†æˆ**ï¼šåº”ç”¨å¯æŒ‰éœ€é€‰æ‹©æ”¯ä»˜æ¸ é“  
âœ… **æ˜“äºæ‰©å±•**ï¼šæ–°å¢æ¸ é“åªéœ€å®ç°æ¥å£  
âœ… **ä¸šåŠ¡éš”ç¦»**ï¼šä¸åŒä¸šåŠ¡çº¿ä½¿ç”¨ä¸åŒæ¸ é“é…ç½®  
âœ… **è‡ªåŠ¨éªŒè¯**ï¼šè‡ªåŠ¨æ£€æµ‹APPå®‰è£…çŠ¶æ€  
âœ… **å‹å¥½UI**ï¼šæä¾›å¼€ç®±å³ç”¨çš„é€‰æ‹©ç•Œé¢  
âœ… **é«˜å¯ç»´æŠ¤**ï¼šæ¨¡å—ç‹¬ç«‹ï¼ŒèŒè´£æ¸…æ™°  
